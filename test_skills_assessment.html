<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skills Assessment Test - UH Pathfinder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        
        .riasec-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .riasec-btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .riasec-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .riasec-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .skills-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .skill-card {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }
        
        .skill-card:hover {
            border-color: #667eea;
            transform: translateX(4px);
        }
        
        .skill-card.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .skill-card.selected .skill-badge {
            background: white;
            color: #667eea;
        }
        
        .skill-name {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .skill-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            opacity: 0.8;
        }
        
        .skill-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .btn {
            padding: 14px 28px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .results h3 {
            color: #667eea;
            margin-bottom: 12px;
        }
        
        .result-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 4px solid #667eea;
        }
        
        .result-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .result-score {
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        
        .error {
            background: #fee;
            border: 2px solid #fcc;
            padding: 15px;
            border-radius: 6px;
            color: #c33;
            margin-top: 15px;
        }
        
        .success {
            background: #efe;
            border: 2px solid #cfc;
            padding: 15px;
            border-radius: 6px;
            color: #363;
            margin-top: 15px;
        }
        
        .insight-box {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .insight-box h4 {
            color: #f57c00;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .insight-box ul {
            margin-left: 20px;
            font-size: 13px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Interest-Weighted Skills Assessment</h1>
            <p>Test the full stack integration - Backend API to Frontend UX</p>
        </div>
        
        <div class="content">
            <!-- Step 1: Select RIASEC -->
            <div class="section">
                <h2>Step 1: Select Your Interest Profile (RIASEC)</h2>
                <div class="riasec-selector">
                    <button class="riasec-btn" data-code="IRE">IRE - Investigative/Realistic/Enterprising</button>
                    <button class="riasec-btn" data-code="ASE">ASE - Artistic/Social/Enterprising</button>
                    <button class="riasec-btn" data-code="IRS">IRS - Investigative/Realistic/Social</button>
                    <button class="riasec-btn" data-code="ECS">ECS - Enterprising/Conventional/Social</button>
                    <button class="riasec-btn" data-code="IAR">IAR - Investigative/Artistic/Realistic</button>
                    <button class="riasec-btn" data-code="SAE">SAE - Social/Artistic/Enterprising</button>
                </div>
                <div id="riasec-selected" style="margin-top: 12px; font-size: 14px; color: #667eea; font-weight: 600;"></div>
            </div>
            
            <!-- Step 2: Load & Select Skills -->
            <div class="section" id="skills-section" style="display: none;">
                <h2>Step 2: Select Tasks You've Done (Top 40 Interest-Matched Skills)</h2>
                <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                    Select skills where you have experience. These will be weighted more heavily in your career matches.
                </p>
                <div id="skills-grid" class="skills-grid"></div>
                <div style="margin-top: 20px; display: flex; gap: 15px;">
                    <button class="btn" id="submit-btn" disabled>Submit Assessment</button>
                    <div style="padding: 14px 0; color: #666; font-size: 14px;">
                        Selected: <span id="selected-count">0</span> skills
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Results -->
            <div class="section" id="results-section" style="display: none;">
                <h2>Step 3: Assessment Results</h2>
                <div id="results-content"></div>
            </div>
            
            <!-- Debug/Status -->
            <div id="status"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let currentRiasec = null;
        let allSkills = [];
        let selectedSkills = new Set();
        
        // RIASEC selection
        document.querySelectorAll('.riasec-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                // Update UI
                document.querySelectorAll('.riasec-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                currentRiasec = e.target.dataset.code;
                document.getElementById('riasec-selected').textContent = `Selected: ${currentRiasec}`;
                
                // Load skills
                await loadSkills(currentRiasec);
            });
        });
        
        async function loadSkills(riasecCode) {
            const status = document.getElementById('status');
            const skillsSection = document.getElementById('skills-section');
            const skillsGrid = document.getElementById('skills-grid');
            
            try {
                status.innerHTML = '<div class="loading">Loading interest-matched skills...</div>';
                
                // Call backend API
                const response = await fetch(`${API_BASE}/assessment/skills/initialize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        riasec_code: riasecCode,
                        selected_skill_ids: []
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                allSkills = data.skills || [];
                selectedSkills.clear();
                
                // Render skills
                skillsGrid.innerHTML = '';
                allSkills.forEach((skill, idx) => {
                    const card = document.createElement('div');
                    card.className = 'skill-card';
                    card.dataset.skillId = skill.element_id;
                    
                    card.innerHTML = `
                        <div class="skill-name">${skill.element_name}</div>
                        <div class="skill-meta">
                            <span class="skill-badge">Rank #${skill.rank}</span>
                            <span>Score: ${skill.score.toFixed(2)}</span>
                        </div>
                    `;
                    
                    card.addEventListener('click', () => toggleSkill(skill.element_id));
                    skillsGrid.appendChild(card);
                });
                
                skillsSection.style.display = 'block';
                status.innerHTML = `<div class="success">‚úì Loaded ${allSkills.length} skills matched to ${riasecCode} interests</div>`;
                
                // Show insight
                displayInitialInsight(allSkills);
                
            } catch (error) {
                console.error('Error loading skills:', error);
                status.innerHTML = `<div class="error">Error loading skills: ${error.message}<br><br>Make sure backend is running: <code>cd uhpathfinder-backend && uvicorn src.main:app --reload</code></div>`;
                skillsSection.style.display = 'none';
            }
        }
        
        function toggleSkill(skillId) {
            const card = document.querySelector(`[data-skill-id="${skillId}"]`);
            
            if (selectedSkills.has(skillId)) {
                selectedSkills.delete(skillId);
                card.classList.remove('selected');
            } else {
                selectedSkills.add(skillId);
                card.classList.add('selected');
            }
            
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const count = selectedSkills.size;
            document.getElementById('selected-count').textContent = count;
            document.getElementById('submit-btn').disabled = count === 0;
        }
        
        function displayInitialInsight(skills) {
            const status = document.getElementById('status');
            const top10 = skills.filter(s => s.rank <= 10);
            const bottom20 = skills.filter(s => s.rank > 20);
            
            const avgTop = top10.reduce((sum, s) => sum + s.score, 0) / top10.length;
            const avgBottom = bottom20.reduce((sum, s) => sum + s.score, 0) / bottom20.length;
            
            const insight = `
                <div class="insight-box">
                    <h4>üí° UX Insight: Pre-Scoring Strategy</h4>
                    <ul>
                        <li><strong>Top 20 skills</strong> (ranks 1-20) start at <strong>DataPoint50</strong> (avg: ${avgTop.toFixed(2)})</li>
                        <li><strong>Bottom 20 skills</strong> (ranks 21-40) start at <strong>DataPoint35</strong> (avg: ${avgBottom.toFixed(2)})</li>
                        <li>Skills you select will be <strong>bumped to DataPoint65</strong></li>
                        <li><strong>Recommended:</strong> Select 3-7 skills where you have real experience to see meaningful differentiation</li>
                    </ul>
                </div>
            `;
            
            status.innerHTML += insight;
        }
        
        // Submit assessment
        document.getElementById('submit-btn').addEventListener('click', async () => {
            const status = document.getElementById('status');
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            
            try {
                status.innerHTML = '<div class="loading">Submitting assessment...</div>';
                
                const response = await fetch(`${API_BASE}/assessment/skills/initialize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        riasec_code: currentRiasec,
                        selected_skill_ids: Array.from(selectedSkills)
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                displayResults(data);
                
            } catch (error) {
                console.error('Error submitting:', error);
                status.innerHTML = `<div class="error">Error submitting assessment: ${error.message}</div>`;
            }
        });
        
        function displayResults(data) {
            const resultsSection = document.getElementById('results-section');
            const resultsContent = document.getElementById('results-content');
            const status = document.getElementById('status');
            
            const skills = data.skills || [];
            const selected = skills.filter(s => s.selected);
            const unselected = skills.filter(s => !s.selected);
            
            // Group selected skills
            const selectedTop10 = selected.filter(s => s.rank <= 10);
            const selectedTop20 = selected.filter(s => s.rank <= 20);
            const selected21Plus = selected.filter(s => s.rank > 20);
            
            // Calculate insights
            const avgSelected = selected.reduce((sum, s) => sum + s.score, 0) / selected.length;
            const avgUnselected = unselected.reduce((sum, s) => sum + s.score, 0) / unselected.length;
            const differential = avgSelected - avgUnselected;
            
            let html = `
                <div class="insight-box">
                    <h4>üìä Assessment Insights</h4>
                    <ul>
                        <li><strong>RIASEC Profile:</strong> ${data.riasec_code}</li>
                        <li><strong>Skills Selected:</strong> ${selected.length} / 40</li>
                        <li><strong>Avg Selected Score:</strong> ${avgSelected.toFixed(3)}</li>
                        <li><strong>Avg Unselected Score:</strong> ${avgUnselected.toFixed(3)}</li>
                        <li><strong>Score Differential:</strong> ${differential.toFixed(3)} ${differential > 0.5 ? '‚úì Good signal' : '‚ö†Ô∏è Low differentiation'}</li>
                    </ul>
                </div>
            `;
            
            // High-value matches
            if (selectedTop10.length > 0) {
                html += `
                    <div class="results">
                        <h3>‚úÖ High-Value Matches (Selected + Top-Ranked)</h3>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            These skills are both interest-aligned AND user-validated. Strong career match indicators.
                        </p>
                `;
                selectedTop10.forEach(skill => {
                    const boost = skill.score - skill.initial_score;
                    html += `
                        <div class="result-item">
                            <div class="result-name">${skill.element_name}</div>
                            <div class="result-score">
                                Rank #${skill.rank} | 
                                Score: ${skill.initial_score.toFixed(2)} ‚Üí ${skill.score.toFixed(2)} 
                                (+${boost.toFixed(2)})
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Potential overestimation
            if (selected21Plus.length > 0) {
                html += `
                    <div class="results">
                        <h3>‚ö†Ô∏è Potential Overestimation (Selected but Low-Ranked)</h3>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            These skills are rare for your interests. Good candidates for LLM refinement.
                        </p>
                `;
                selected21Plus.forEach(skill => {
                    const boost = skill.score - skill.initial_score;
                    html += `
                        <div class="result-item">
                            <div class="result-name">${skill.element_name}</div>
                            <div class="result-score">
                                Rank #${skill.rank} | 
                                Score: ${skill.initial_score.toFixed(2)} ‚Üí ${skill.score.toFixed(2)} 
                                (+${boost.toFixed(2)})
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // Unselected high-priority
            const unselectedTop = unselected.filter(s => s.rank <= 10);
            if (unselectedTop.length > 0) {
                html += `
                    <div class="results">
                        <h3>üîç Skills to Develop (High Interest-Match, Not Selected)</h3>
                        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
                            These are aligned with your interests but you haven't performed them yet.
                        </p>
                `;
                unselectedTop.slice(0, 5).forEach(skill => {
                    html += `
                        <div class="result-item">
                            <div class="result-name">${skill.element_name}</div>
                            <div class="result-score">
                                Rank #${skill.rank} | Score: ${skill.score.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // UX Recommendations
            html += `
                <div class="insight-box" style="background: #e3f2fd; border-color: #2196f3;">
                    <h4>üéØ UX Recommendations</h4>
                    <ul>
                        <li>${selectedTop10.length > 0 ? '‚úì' : '‚óã'} Show "High-Value Matches" prominently in career results</li>
                        <li>${selected21Plus.length > 0 ? '‚úì' : '‚óã'} Flag low-ranked selections for optional LLM refinement</li>
                        <li>${unselectedTop.length > 0 ? '‚úì' : '‚óã'} Suggest "Skills to Develop" as learning pathways</li>
                        <li>${differential > 0.5 ? '‚úì' : '‚ö†Ô∏è'} Score differential: ${differential > 0.5 ? 'Good signal' : 'Consider prompting for more selections'}</li>
                    </ul>
                </div>
            `;
            
            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';
            status.innerHTML = '<div class="success">‚úì Assessment complete! Review insights above.</div>';
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
